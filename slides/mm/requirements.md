# イベント参加者管理アプリ 要件定義書  
（最小構成／フロントエンド単体＋Google スプレッドシート）

---

## 1. 概要
本アプリは、**Googleフォームの回答一覧スプレッドシート（以下「回答シート」）**をデータソースとして利用し、  
**(1) 参加者のチェックイン** と **(2) 管理者による参加者一覧の閲覧** の2機能を提供するフロントエンドアプリです。

Googleフォーム自体の作成および設問内容は本システムの対象外とし、  
既に存在するフォームの**回答スプレッドシートのみを参照・更新**します。

---

## 2. 対象ユーザー

| ユーザー | 目的 | 権限 |
|-----------|------|------|
| 管理者（Organizer） | 参加者一覧の閲覧、回答シートURL設定 | 一覧閲覧・設定変更 |
| 受付担当（Staff） | 当日のチェックイン処理 | 氏名完全一致検索・チェックイン更新のみ |

---

## 3. 利用シナリオ

1. **事前準備（管理者）**
   - Googleフォームを作成（設問内容は管理者が設計）。
   - 自動生成された**回答シートのURL**を本アプリに設定。
   - 初回アクセス時に**接続テスト**を実行し、読み書き権限を確認。
   - 回答シートに本アプリ用の**システム列**を自動追加（同意制）。

2. **受付当日（受付担当）**
   - 受付画面にアクセス。
   - **氏名の完全一致**で照合（候補・サジェスト表示なし）。
   - 一致した1件のみを表示 → 「チェックイン」ボタンで入場処理。
   - 回答シートのシステム列を更新（`_checkin_status`など）。
   - 誤操作は一定時間内にUndo可能。

3. **運用（管理者）**
   - 一覧画面で参加者の入場状況を確認。
   - 検索・並び替え・CSV出力が可能。

---

## 4. 機能要件

### 4.1 チェックイン
- **照合方法**：氏名完全一致のみ（部分一致・候補表示禁止）。
- **表示情報**：一致1件の最小情報（氏名・フォーム項目一部・入場状態）。
- **更新項目**：以下のシステム列を回答シートに直接書き込み。  
- **冪等性**：既に入場済の参加者は再チェックイン不可。  
- **Undo**：直後のみ可能（取消操作もログ記録）。  
- **オフライン対応**：通信失敗時は一時保存し、回復後に送信。

### 4.2 参加者一覧（管理者）
- **一覧表示**：回答シート全体を読み取り、Web上で表示。  
- **検索／フィルタ**：氏名・メールなどで検索、入場状態で絞込。  
- **並び替え**：氏名、申込日時、入場時刻など。  
- **CSV出力**：現在のフィルタ条件でエクスポート可能。  
- **編集**：フォーム回答内容は編集不可（チェックイン情報のみ更新）。

---

## 5. 非機能要件

| 区分 | 要件 |
|------|------|
| パフォーマンス | 参加者数5,000件で初回ロード3秒以内、検索200ms以内。 |
| 信頼性 | 更新前に`_updated_at`を比較し、競合を防止。 |
| 可用性 | ネット不調時に操作をキュー化、復帰後自動送信。 |
| セキュリティ | Google OAuth2で認証、必要最小スコープのみ使用。 |
| プライバシー | 氏名照合は完全一致、他人情報を非表示。 |
| 監査性 | 更新時に操作者・時刻を自動記録。 |
| 対応環境 | Chrome/Safari/Firefox 最新2バージョン対応。 |

---

## 6. データ設計

### 6.1 対象シート
- Googleフォームの回答シート（例：`Form Responses 1`）
- 本システムが末尾に**システム用列**を追加

### 6.2 既存列（例）
| 列名 | 備考 |
|------|------|
| Timestamp | 回答日時 |
| 氏名 | 完全一致照合に使用（設定で列指定） |
| メールアドレス | 検索用（任意） |
| その他設問列 | 任意項目 |

### 6.3 システム用列
| 列名 | 型 | 説明 |
|------|------|------|
| `_participant_id` | 文字列 | 行ID（自動採番） |
| `_checkin_status` | ENUM | `not_checked_in` / `checked_in` |
| `_checkin_at` | 日時 | 最終チェックイン時刻 |
| `_checkin_by` | 文字列 | 操作者（受付担当） |
| `_updated_at` | 日時 | 最終更新時刻 |
| `_updated_by` | 文字列 | 最終更新者 |
| `_audit_note` | 文字列 | 任意の備考（取消理由など） |

---

## 7. UI要件

### 7.1 管理者画面
- 回答シートURL入力欄  
- 接続テスト（読み書き確認）  
- 氏名列のマッピング設定  
- 一覧表示（検索・並び替え・CSV出力）

### 7.2 受付画面
- 氏名完全一致入力欄  
- 一致時に最小情報表示（氏名・入場状態・更新時刻）  
- 「チェックイン」／「Undo」ボタン  
- エラーメッセージ（該当なし・通信失敗など）

---

## 8. セキュリティ要件
- **認証**：Google OAuth 2（Identity Services）  
- **権限管理**：スプレッドシート共有権限に準拠（管理者＝編集、受付担当＝対象ブック編集のみ）  
- **通信**：HTTPS必須  
- **トークン管理**：短期保持、永続保存禁止  
- **データ表示制御**：受付画面では一致1件のみ表示、候補非表示  
- **監査**：`_updated_at`, `_updated_by` により操作履歴を保持  

---

## 9. 拡張案
| 機能 | 概要 |
|------|------|
| 監査ログシート追加 | `AuditLog`シートを別途作成し、操作履歴を追記保存 |
| QRチェックイン | 署名付きトークンQRコードで受付を高速化 |
| 参加者セルフ確認 | 参加者が自分の入場状況を確認可能 |
| 多イベント対応 | 複数回答シートを登録し切替可能に |

---

## 10. 実装メモ
- **列マッピング**：管理者が「氏名列」を設定可能。  
- **読み込み**：範囲指定で必要列のみ取得、差分更新対応。  
- **書き込み**：チェックイン列のみ更新（フォーム回答列は不変更）。  
- **競合回避**：`_updated_at` 比較で再読込を促す。  
- **オフライン対応**：操作キューをIndexedDBに保存、復帰時送信。  
- **出力**：CSV変換はブラウザ上で完結。

---

**この仕様により、既存フォームをそのまま活かしつつ、最小構成での参加者チェックインと一覧管理を実現します。**
